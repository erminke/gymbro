<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Data Cleanup Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üßπ User Data Cleanup Test</h1>
    <p>This test will demonstrate that users get clean, fresh data when logging in.</p>
    
    <div>
        <h3>Step 1: Check current localStorage</h3>
        <button class="button" onclick="checkCurrentData()">Check Current localStorage</button>
        <div id="current-data-result"></div>
    </div>
    
    <div>
        <h3>Step 2: Add some test data to localStorage</h3>
        <button class="button" onclick="addTestData()">Add Test Data</button>
        <div id="test-data-result"></div>
    </div>
    
    <div>
        <h3>Step 3: Login as test user (should clear all data)</h3>
        <button class="button" onclick="loginTestUser()">Login Test User</button>
        <div id="login-result"></div>
    </div>
    
    <div>
        <h3>Step 4: Check localStorage after login</h3>
        <button class="button" onclick="checkDataAfterLogin()">Check Data After Login</button>
        <div id="after-login-result"></div>
    </div>
    
    <div>
        <h3>Step 5: Add user-specific data</h3>
        <button class="button" onclick="addUserData()">Add User Data</button>
        <div id="user-data-result"></div>
    </div>
    
    <div>
        <h3>Step 6: Logout and check data cleanup</h3>
        <button class="button" onclick="testLogout()">Logout</button>
        <div id="logout-result"></div>
    </div>

    <script>
        let currentToken = null;
        
        function checkCurrentData() {
            const result = document.getElementById('current-data-result');
            const keys = Object.keys(localStorage);
            const relevantKeys = keys.filter(key => 
                key.includes('gains') || 
                key.includes('workout') || 
                key.includes('meal') || 
                key.includes('supplement') ||
                key.includes('auth') ||
                key.includes('user')
            );
            
            if (relevantKeys.length === 0) {
                result.innerHTML = '<div class="info">‚úÖ No relevant data in localStorage</div>';
            } else {
                result.innerHTML = `<div class="info">üì¶ Found ${relevantKeys.length} keys: ${relevantKeys.join(', ')}</div>`;
            }
        }
        
        function addTestData() {
            const result = document.getElementById('test-data-result');
            
            // Add some fake data that should be cleared
            const fakeData = {
                workoutHistory: [
                    { id: '1', type: 'OLD WORKOUT', date: '2024-01-01', duration: 60 }
                ],
                mealHistory: [
                    { id: '1', type: 'OLD MEAL', date: '2024-01-01', food: 'Old food' }
                ],
                weightTracking: {
                    history: [
                        { date: '2024-01-01', weight: 80, timestamp: '2024-01-01T10:00:00Z' }
                    ]
                }
            };
            
            localStorage.setItem('gainsData', JSON.stringify(fakeData));
            localStorage.setItem('currentPage', 'dashboard');
            localStorage.setItem('some_old_key', 'old_value');
            
            result.innerHTML = '<div class="success">‚úÖ Added fake test data to localStorage</div>';
        }
        
        async function loginTestUser() {
            const result = document.getElementById('login-result');
            
            try {
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    currentToken = data.token;
                    
                    // Simulate the clearLocalAppData function from api.js
                    const keysToKeep = ['auth_token', 'user_data', 'last_sync'];
                    const allKeys = Object.keys(localStorage);
                    
                    allKeys.forEach(key => {
                        if (!keysToKeep.includes(key)) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // Initialize empty data structure
                    const emptyData = {
                        workoutHistory: [],
                        progressTracking: {},
                        supplementTracking: {},
                        mealHistory: [],
                        customSupplements: [],
                        goals: [],
                        weightTracking: {
                            profile: {},
                            history: []
                        },
                        plannedExercises: {},
                        customWorkoutPlan: {},
                        settings: {
                            units: 'metric',
                            theme: 'light'
                        }
                    };
                    
                    localStorage.setItem('gainsData', JSON.stringify(emptyData));
                    
                    result.innerHTML = `<div class="success">‚úÖ User logged in: ${data.user.email}<br>üßπ Local data cleared and fresh structure initialized</div>`;
                } else {
                    result.innerHTML = `<div class="error">‚ùå Login failed: ${data.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function checkDataAfterLogin() {
            const result = document.getElementById('after-login-result');
            const gainsData = localStorage.getItem('gainsData');
            
            if (gainsData) {
                const data = JSON.parse(gainsData);
                const isEmpty = {
                    workouts: (data.workoutHistory || []).length === 0,
                    meals: (data.mealHistory || []).length === 0,
                    weight: (data.weightTracking?.history || []).length === 0,
                    supplements: Object.keys(data.supplementTracking || {}).length === 0
                };
                
                const allEmpty = Object.values(isEmpty).every(empty => empty);
                
                if (allEmpty) {
                    result.innerHTML = '<div class="success">‚úÖ Perfect! All user data arrays are empty</div>';
                } else {
                    result.innerHTML = `<div class="error">‚ùå Some data still exists: ${JSON.stringify(isEmpty, null, 2)}</div>`;
                }
            } else {
                result.innerHTML = '<div class="error">‚ùå No gainsData found in localStorage</div>';
            }
        }
        
        async function addUserData() {
            const result = document.getElementById('user-data-result');
            if (!currentToken) {
                result.innerHTML = '<div class="error">‚ùå Please login first</div>';
                return;
            }
            
            try {
                const userData = {
                    workoutHistory: [
                        {
                            id: Date.now().toString(),
                            type: 'NEW USER WORKOUT',
                            date: new Date().toISOString().split('T')[0],
                            duration: 45,
                            exercises: 'Bench Press, Squats',
                            notes: 'Fresh user workout!',
                            timestamp: new Date().toISOString()
                        }
                    ],
                    mealHistory: [
                        {
                            id: Date.now().toString(),
                            type: 'NEW USER MEAL',
                            date: new Date().toISOString().split('T')[0],
                            food: 'Healthy breakfast',
                            timestamp: new Date().toISOString()
                        }
                    ]
                };
                
                const response = await fetch('http://localhost:3000/api/data/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                if (response.ok) {
                    result.innerHTML = '<div class="success">‚úÖ User-specific data added to server</div>';
                } else {
                    result.innerHTML = `<div class="error">‚ùå Failed to add data: ${data.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function testLogout() {
            const result = document.getElementById('logout-result');
            
            // Simulate logout - clear everything
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            localStorage.removeItem('last_sync');
            localStorage.removeItem('gainsData');
            
            currentToken = null;
            
            const remainingKeys = Object.keys(localStorage);
            if (remainingKeys.length === 0) {
                result.innerHTML = '<div class="success">‚úÖ Perfect! All data cleared on logout</div>';
            } else {
                result.innerHTML = `<div class="info">‚ÑπÔ∏è Remaining keys: ${remainingKeys.join(', ')}</div>`;
            }
        }
    </script>
</body>
</html>
